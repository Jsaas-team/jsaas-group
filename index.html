<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุฌุณูุงุณ ูุฅุฏุงุฑุฉ ุงููุดุงุฑูุน</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .brand-color { color: #fe9b02; }
        .bg-brand { background-color: #fe9b02; }
        .btn-primary { background-color: #fe9b02; color: white; transition: 0.3s; }
        .btn-primary:hover { background-color: #e58a00; }
        
        /* ุชูุณูู ุงููุงูุฐุฉ ุงูููุจุซูุฉ ูุชููู ูุงุจูุฉ ููุชูุฑูุฑ */
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* ุชุฃุซูุฑุงุช ุงูุชูุงููุฉ */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="app">
    <div v-if="loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-500"></div>
    </div>

    <div v-if="!user && !loading" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-6 brand-color">ูุธุงู ุฌุณูุงุณ</h1>
            
            <div class="flex mb-6 border-b">
                <button @click="authMode = 'login'" :class="{'border-b-2 border-orange-500 text-orange-600': authMode === 'login'}" class="w-1/2 py-2 font-bold">ุฏุฎูู</button>
                <button @click="authMode = 'signup'" :class="{'border-b-2 border-orange-500 text-orange-600': authMode === 'signup'}" class="w-1/2 py-2 font-bold">ุชุณุฌูู ุฌุฏูุฏ</button>
            </div>

            <form @submit.prevent="handleAuth">
                <div class="mb-4" v-if="authMode === 'signup'">
                    <label class="block mb-1 font-semibold">ุงูุงุณู ุงููุงูู</label>
                    <input v-model="authForm.name" type="text" class="w-full p-2 border rounded focus:ring-2 focus:ring-orange-400 outline-none" required>
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-semibold">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                    <input v-model="authForm.email" type="email" class="w-full p-2 border rounded focus:ring-2 focus:ring-orange-400 outline-none" required>
                </div>
                <div class="mb-6">
                    <label class="block mb-1 font-semibold">ูููุฉ ุงููุฑูุฑ</label>
                    <input v-model="authForm.password" type="password" class="w-full p-2 border rounded focus:ring-2 focus:ring-orange-400 outline-none" required>
                </div>
                <button type="submit" class="w-full btn-primary py-2 rounded-lg font-bold text-lg shadow-md">
                    {{ authMode === 'login' ? 'ุชุณุฌูู ุงูุฏุฎูู' : 'ุฅูุดุงุก ุญุณุงุจ' }}
                </button>
            </form>
            <p v-if="errorMsg" class="mt-4 text-red-600 text-center font-bold text-sm bg-red-100 p-2 rounded">{{ errorMsg }}</p>
        </div>
    </div>

    <div v-if="user && userStatus === 'pending'" class="min-h-screen flex flex-col items-center justify-center p-4 text-center">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg">
            <i class="fas fa-clock text-6xl text-orange-400 mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">ุญุณุงุจู ููุฏ ุงููุฑุงุฌุนุฉ</h2>
            <p class="text-gray-600 mb-6">ูุฑุญุจุงู {{ userData?.name }}ุ ุชู ุชุณุฌูู ุทูุจู ุจูุฌุงุญ. ูุฑุฌู ุงูุชุธุงุฑ ููุงููุฉ ุงููุฏูุฑ ูุชูุนูู ุญุณุงุจู.</p>
            <button @click="logout" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ุฎุฑูุฌ</button>
        </div>
    </div>

    <div v-if="user && userStatus === 'active'" class="flex min-h-screen">
        
        <aside class="w-64 bg-gray-900 text-white hidden md:flex flex-col shadow-xl">
            <div class="p-6 border-b border-gray-700 text-center">
                <h1 class="text-2xl font-bold text-orange-500">ุฌุณูุงุณ ููููุงููุงุช</h1>
                <p class="text-xs text-gray-400 mt-1">ูุธุงู ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a @click="currentView = 'dashboard'" :class="{'bg-orange-600': currentView === 'dashboard'}" class="flex items-center p-3 rounded cursor-pointer hover:bg-gray-800 transition">
                    <i class="fas fa-chart-pie w-8 text-center"></i> ููุญุฉ ุงูุชุญูู
                </a>
                <a @click="currentView = 'tasks'" :class="{'bg-orange-600': currentView === 'tasks'}" class="flex items-center p-3 rounded cursor-pointer hover:bg-gray-800 transition">
                    <i class="fas fa-tasks w-8 text-center"></i> ุงูููุงู
                </a>
                <a v-if="isAdmin" @click="currentView = 'users'" :class="{'bg-orange-600': currentView === 'users'}" class="flex items-center p-3 rounded cursor-pointer hover:bg-gray-800 transition">
                    <i class="fas fa-users w-8 text-center"></i> ุงูููุธููู
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-orange-500 flex items-center justify-center font-bold text-white ml-3">
                        {{ userData?.name?.charAt(0) }}
                    </div>
                    <div>
                        <p class="text-sm font-bold">{{ userData?.name }}</p>
                        <p class="text-xs text-gray-400">{{ userData?.role === 'admin' ? 'ูุฏูุฑ ุงููุธุงู' : 'ููุธู' }}</p>
                    </div>
                </div>
                <button @click="logout" class="w-full py-2 bg-red-600 rounded text-sm hover:bg-red-700">ุชุณุฌูู ุฎุฑูุฌ</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow p-4 flex justify-between items-center z-10">
                <div class="md:hidden font-bold text-orange-600 text-xl">ุฌุณูุงุณ</div>
                <div class="flex-1"></div> <div class="relative ml-4">
                    <button @click="showNotifications = !showNotifications" class="relative p-2 text-gray-600 hover:text-orange-500">
                        <i class="fas fa-bell fa-lg"></i>
                        <span v-if="notifications.length > 0" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                            {{ notifications.length }}
                        </span>
                    </button>
                    <div v-if="showNotifications" class="absolute left-0 mt-2 w-72 bg-white border rounded shadow-xl z-50">
                        <div class="p-3 font-bold border-b bg-gray-50">ุงูุฅุดุนุงุฑุงุช</div>
                        <ul class="max-h-60 overflow-y-auto">
                            <li v-for="notif in notifications" :key="notif.id" class="p-3 border-b text-sm hover:bg-gray-50">
                                {{ notif.message }}
                            </li>
                            <li v-if="notifications.length === 0" class="p-3 text-center text-gray-500 text-sm">ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ุฌุฏูุฏุฉ</li>
                        </ul>
                    </div>
                </div>
                
                <button class="md:hidden mr-4 text-gray-600"><i class="fas fa-bars fa-lg"></i></button>
            </header>

            <div class="flex-1 overflow-auto p-6">
                
                <div v-if="currentView === 'dashboard'">
                    <h2 class="text-2xl font-bold mb-6 text-gray-700">ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุดุฑูุน</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md border-r-4 border-blue-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500 text-sm">ุฅุฌูุงูู ุงูููุงู</p>
                                    <h3 class="text-3xl font-bold">{{ tasks.length }}</h3>
                                </div>
                                <i class="fas fa-clipboard-list text-3xl text-blue-200"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md border-r-4 border-green-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500 text-sm">ููุชููุฉ</p>
                                    <h3 class="text-3xl font-bold">{{ tasks.filter(t => t.status === 'completed').length }}</h3>
                                </div>
                                <i class="fas fa-check-circle text-3xl text-green-200"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md border-r-4 border-orange-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500 text-sm">ููุฏ ุงูุชูููุฐ</p>
                                    <h3 class="text-3xl font-bold">{{ tasks.filter(t => t.status === 'in-progress').length }}</h3>
                                </div>
                                <i class="fas fa-hard-hat text-3xl text-orange-200"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                        <h3 class="font-bold mb-4 text-gray-700 text-center">ูุนุฏูุงุช ุงูุฅูุฌุงุฒ</h3>
                        <canvas id="myChart"></canvas>
                    </div>
                </div>

                <div v-if="currentView === 'tasks'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-700">ูุงุฆูุฉ ุงูููุงู</h2>
                        <button @click="openModal('add')" class="btn-primary px-4 py-2 rounded shadow flex items-center gap-2">
                            <i class="fas fa-plus"></i> ุฅุถุงูุฉ ูููุฉ
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="task in tasks" :key="task.id" class="bg-white rounded-lg shadow hover:shadow-lg transition overflow-hidden border border-gray-100">
                            <div class="h-32 bg-gray-200 relative">
                                <img v-if="task.image" :src="task.image" class="w-full h-full object-cover">
                                <div v-else class="w-full h-full flex items-center justify-center text-gray-400">
                                    <i class="fas fa-image fa-2x"></i>
                                </div>
                                <span class="absolute top-2 left-2 px-2 py-1 text-xs rounded-full text-white font-bold"
                                      :class="{'bg-green-500': task.status === 'completed', 'bg-orange-500': task.status === 'in-progress', 'bg-red-500': task.status === 'pending'}">
                                    {{ getStatusText(task.status) }}
                                </span>
                            </div>
                            <div class="p-4">
                                <h3 class="font-bold text-lg mb-1">{{ task.title }}</h3>
                                <p class="text-gray-500 text-sm mb-3">{{ task.description }}</p>
                                <div class="flex justify-between text-xs text-gray-400 mb-4">
                                    <span><i class="far fa-calendar-alt"></i> {{ task.date }}</span>
                                    <span><i class="fas fa-user"></i> {{ task.assignedTo || 'ุบูุฑ ูุญุฏุฏ' }}</span>
                                </div>
                                <div class="flex justify-end gap-2 border-t pt-3">
                                    <button @click="editTask(task)" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i> ุชุนุฏูู</button>
                                    <button @click="deleteTask(task.id)" class="text-red-500 hover:text-red-700 mr-2"><i class="fas fa-trash"></i> ุญุฐู</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentView === 'users' && isAdmin">
                    <h2 class="text-2xl font-bold mb-6 text-gray-700">ุฅุฏุงุฑุฉ ูุฑูู ุงูุนูู</h2>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="w-full text-right">
                            <thead class="bg-gray-100 text-gray-600 border-b">
                                <tr>
                                    <th class="p-4">ุงูุงุณู</th>
                                    <th class="p-4">ุงูุฏูุฑ</th>
                                    <th class="p-4">ุงูุญุงูุฉ</th>
                                    <th class="p-4">ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="u in users" :key="u.id" class="border-b hover:bg-gray-50">
                                    <td class="p-4 font-bold">{{ u.name }} <br> <span class="text-xs text-gray-400 font-normal">{{ u.email }}</span></td>
                                    <td class="p-4">
                                        <span v-if="u.role === 'admin'" class="text-purple-600 font-bold">ูุฏูุฑ</span>
                                        <span v-else class="text-gray-600">ููุธู</span>
                                    </td>
                                    <td class="p-4">
                                        <span v-if="u.status === 'active'" class="text-green-600 bg-green-100 px-2 py-1 rounded text-xs">ูุดุท</span>
                                        <span v-if="u.status === 'pending'" class="text-orange-600 bg-orange-100 px-2 py-1 rounded text-xs">ุงูุชุธุงุฑ</span>
                                        <span v-if="u.status === 'banned'" class="text-red-600 bg-red-100 px-2 py-1 rounded text-xs">ูุญุธูุฑ</span>
                                    </td>
                                    <td class="p-4 flex gap-2">
                                        <button v-if="u.status === 'pending'" @click="updateUserStatus(u.id, 'active')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">ูุจูู</button>
                                        <button v-if="u.status === 'active'" @click="updateUserStatus(u.id, 'banned')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">ุญุธุฑ/ุทุฑุฏ</button>
                                        <button v-if="u.status === 'banned'" @click="updateUserStatus(u.id, 'active')" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">ุฅูุบุงุก ุงูุญุธุฑ</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div v-if="showModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg">{{ modalMode === 'add' ? 'ุฅุถุงูุฉ ูููุฉ ุฌุฏูุฏุฉ' : 'ุชุนุฏูู ุงููููุฉ' }}</h3>
                <button @click="closeModal" class="text-gray-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="p-6 modal-body">
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">ุนููุงู ุงููููุฉ</label>
                    <input v-model="taskForm.title" type="text" class="w-full border p-2 rounded focus:ring-2 focus:ring-orange-400 outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">ุงููุตู</label>
                    <textarea v-model="taskForm.description" class="w-full border p-2 rounded focus:ring-2 focus:ring-orange-400 outline-none h-24"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">ุชุงุฑูุฎ ุงูุชุณููู</label>
                        <input v-model="taskForm.date" type="date" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">ุงูุญุงูุฉ</label>
                        <select v-model="taskForm.status" class="w-full border p-2 rounded">
                            <option value="pending">ููุฏ ุงูุงูุชุธุงุฑ</option>
                            <option value="in-progress">ุฌุงุฑู ุงูุนูู</option>
                            <option value="completed">ููุชููุฉ</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                   <label class="block text-sm font-bold mb-1">ุตูุฑุฉ (ุฃุฏุฎู ุงูุฑุงุจุท ุฃู ุงุฑูุน ููู)</label>
                   <input type="file" @change="handleFileUpload" class="mb-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"/>
                   <input v-model="taskForm.image" placeholder="ุฃู ุงูุตู ุฑุงุจุท ุงูุตูุฑุฉ ููุง" type="text" class="w-full border p-2 rounded text-sm text-gray-600">
                </div>
            </div>
            
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-2">
                <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">ุฅูุบุงุก</button>
                <button @click="saveTask" class="px-6 py-2 bg-orange-500 text-white rounded font-bold hover:bg-orange-600">ุญูุธ</button>
            </div>
        </div>
    </div>

</div>

<script>
const app = Vue.createApp({
    data() {
        return {
            // ุจูุงูุงุช ุงูุชููุฆุฉ
            loading: true,
            user: null,
            userData: null, // ุจูุงูุงุช ุงููุณุชุฎุฏู ูู Firestore
            authMode: 'login', // login or signup
            currentView: 'dashboard',
            
            // ุงูููุงุฐุฌ
            authForm: { name: '', email: '', password: '' },
            taskForm: { id: null, title: '', description: '', date: '', status: 'pending', image: '' },
            errorMsg: '',
            
            // ุงูุจูุงูุงุช
            tasks: [],
            users: [], // ูููุฏูุฑ ููุท
            notifications: [],
            
            // ุงูุชุญูู ุจุงููุงูุฐุฉ
            showModal: false,
            modalMode: 'add',
            showNotifications: false,

            // ุงููุชุบูุฑุงุช ุงูุนุงูููุฉ
            db: null,
            auth: null
        }
    },
    computed: {
        isAdmin() {
            return this.userData && this.userData.role === 'admin';
        },
        userStatus() {
            return this.userData ? this.userData.status : null; // active, pending, banned
        }
    },
    methods: {
        async initFirebase() {
            // โ๏ธ ูุงู: ุงุณุชุจุฏู ุงูุจูุงูุงุช ุฃุฏูุงู ุจุจูุงูุงุช ูุดุฑูุนู ูู Firebase Console
            const firebaseConfig = {
                apiKey: "AIzaSy_XXXXXXXXXXXXXXXXXXXXXXXX",
                authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT_ID.appspot.com",
                messagingSenderId: "XXXXXXXXXXXX",
                appId: "1:XXXXXXXXXXXX:web:XXXXXXXXXXXX"
            };

            firebase.initializeApp(firebaseConfig);
            this.db = firebase.firestore();
            this.auth = firebase.auth();
        },

        // --- ุงููุตุงุฏูุฉ ---
        async handleAuth() {
            this.errorMsg = '';
            try {
                if (this.authMode === 'login') {
                    await this.auth.signInWithEmailAndPassword(this.authForm.email, this.authForm.password);
                } else {
                    const cred = await this.auth.createUserWithEmailAndPassword(this.authForm.email, this.authForm.password);
                    // ุฅูุดุงุก ููู ุงููุณุชุฎุฏู ูู Firestore (ุงูุชุฑุงุถูุงู: ููุธู + ููุฏ ุงูุงูุชุธุงุฑ)
                    await this.db.collection('users').doc(cred.user.uid).set({
                        name: this.authForm.name,
                        email: this.authForm.email,
                        role: 'employee', 
                        status: 'pending', // ุงูุฃูุงู: ูุฌุจ ุชูุนูู ุงูุญุณุงุจ ูุฏููุงู
                        createdAt: new Date()
                    });
                }
            } catch (error) {
                this.errorMsg = "ุญุฏุซ ุฎุทุฃ: " + error.message;
            }
        },
        logout() {
            this.auth.signOut();
            this.user = null;
            this.userData = null;
            location.reload(); // ุฅุนุงุฏุฉ ุชุญููู ูุธููุฉ
        },

        // --- ุงููุฑุงูุจุฉ ุงูุญูุฉ (ุงูุฃูุงู + ุงูุจูุงูุงุช) ---
        setupRealtimeListeners(uid) {
            // 1. ูุฑุงูุจุฉ ุญุงูุฉ ุงููุณุชุฎุฏู ููุณู (ููุทุฑุฏ ุงูููุฑู)
            this.db.collection('users').doc(uid).onSnapshot((doc) => {
                if (doc.exists) {
                    this.userData = doc.data();
                    
                    // ๐ก๏ธ ุงูุฃูุงู: ุงูุทุฑุฏ ุงูููุฑู ุฅุฐุง ุชู ุงูุญุธุฑ
                    if (this.userData.status === 'banned') {
                        alert("ุชู ุชุนุทูู ุญุณุงุจู ูู ูุจู ุงูุฅุฏุงุฑุฉ.");
                        this.logout();
                    }
                } else {
                    // ุฅุฐุง ุชู ุญุฐู ุงููุณุชุฎุฏู ููู ูุณุฌู ุฏุฎูู
                    this.logout();
                }
                this.loading = false;
            });

            // 2. ุฌูุจ ุงูููุงู
            this.db.collection('tasks').onSnapshot((snapshot) => {
                this.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                this.updateChart();
                this.checkDeadlines(); // ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช
            });

            // 3. ุฌูุจ ุงููุณุชุฎุฏููู (ูููุฏูุฑ ููุท)
            // ูุชุญูู ุฃููุงู ุฅุฐุง ูุงู ูุฏูุฑุงูุ ููู ููุง ุณูุฌูุจูุง ูุจุณุจุจ Firestore Rules ูู ุชุธูุฑ ุฅูุง ูููุฏูุฑ
            if (true) { 
                this.db.collection('users').onSnapshot((snapshot) => {
                    this.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }, error => {
                   // ุชุฌุงูู ุงูุฎุทุฃ ุฅุฐุง ูู ููู ูุฏูุฑุงู (ุจุณุจุจ ุงูู Rules)
                   console.log("Not admin, can't list users");
                });
            }
        },

        // --- ุฅุฏุงุฑุฉ ุงูููุงู ---
        openModal(mode, task = null) {
            this.modalMode = mode;
            if (mode === 'edit' && task) {
                this.taskForm = { ...task };
            } else {
                this.taskForm = { title: '', description: '', date: '', status: 'pending', image: '' };
            }
            this.showModal = true;
        },
        closeModal() {
            this.showModal = false;
        },
        handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // ุชุญููู ุงูุตูุฑุฉ ุฅูู Base64 (ููุชุฎุฒูู ุงูุจุณูุท)
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.taskForm.image = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        },
        async saveTask() {
            if (!this.taskForm.title) return;
            try {
                const taskData = {
                    title: this.taskForm.title,
                    description: this.taskForm.description,
                    date: this.taskForm.date,
                    status: this.taskForm.status,
                    image: this.taskForm.image,
                    updatedAt: new Date()
                };

                if (this.modalMode === 'add') {
                    taskData.createdAt = new Date();
                    taskData.assignedTo = this.userData.name; // ูู ุฃูุดุฃ ุงููููุฉ
                    await this.db.collection('tasks').add(taskData);
                } else {
                    await this.db.collection('tasks').doc(this.taskForm.id).update(taskData);
                }
                this.closeModal();
            } catch (e) {
                alert("ุฎุทุฃ ูู ุงูุญูุธ: " + e.message);
            }
        },
        async deleteTask(id) {
            if(confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ")) {
                await this.db.collection('tasks').doc(id).delete();
            }
        },

        // --- ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู (ูููุฏูุฑ) ---
        async updateUserStatus(uid, newStatus) {
            await this.db.collection('users').doc(uid).update({ status: newStatus });
        },

        // --- ุฃุฏูุงุช ูุณุงุนุฏุฉ ---
        getStatusText(status) {
            const map = { 'pending': 'ููุฏ ุงูุงูุชุธุงุฑ', 'in-progress': 'ุฌุงุฑู ุงูุนูู', 'completed': 'ููุชููุฉ' };
            return map[status] || status;
        },
        updateChart() {
            const ctx = document.getElementById('myChart');
            if (!ctx) return;
            
            // ุชุฏููุฑ ุงูุฑุณู ุงููุฏูู ุฅู ูุฌุฏ
            if (window.myChartInstance) window.myChartInstance.destroy();

            const completed = this.tasks.filter(t => t.status === 'completed').length;
            const progress = this.tasks.filter(t => t.status === 'in-progress').length;
            const pending = this.tasks.filter(t => t.status === 'pending').length;

            window.myChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ููุชููุฉ', 'ุฌุงุฑู ุงูุนูู', 'ุงูุชุธุงุฑ'],
                    datasets: [{
                        data: [completed, progress, pending],
                        backgroundColor: ['#10B981', '#F97316', '#EF4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        },
        checkDeadlines() {
            // ููุทู ุจุณูุท ููุฅุดุนุงุฑุงุช
            this.notifications = [];
            const today = new Date().toISOString().split('T')[0];
            this.tasks.forEach(task => {
                if (task.date === today && task.status !== 'completed') {
                    this.notifications.push({ id: task.id, message: `ุชูุจูู: ุงููููุฉ "${task.title}" ุชุณุชุญู ุงูุชุณููู ุงูููู!` });
                }
            });
        },
    },
    mounted() {
        this.initFirebase();
        
        // ูุฑุงูุจ ุญุงูุฉ ุงููุตุงุฏูุฉ ุงูุฑุฆูุณู
        this.auth.onAuthStateChanged((user) => {
            if (user) {
                this.user = user;
                this.setupRealtimeListeners(user.uid);
            } else {
                this.user = null;
                this.userData = null;
                this.loading = false;
            }
        });
    },
    updated() {
        // ุฅุนุงุฏุฉ ุฑุณู ุงูู Chart ุนูุฏ ุชุบููุฑ ุงูู View ุฅูู Dashboard
        if (this.currentView === 'dashboard' && !window.myChartInstance && this.tasks.length > 0) {
             this.updateChart();
        }
    }
});

app.mount('#app');
</script>
</body>
</html>