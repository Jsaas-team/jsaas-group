<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إدارة الصيانة - لوحة المعلومات الحية</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --brand-orange: #fe9b02;
            --brand-red: #f53f2c;
            --dashboard-dark-blue: #000c3b;
            --bg-body: #f8f9fa; 
            --text-main: #333;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* === تخطيط الشبكة (Grid Layout) === */
        /* تقسيم الشاشة لـ 3 أعمدة متساوية لتقليد الصورة */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px;
            align-items: start;
        }

        /* العمود (Column) */
        .dashboard-col {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* الكروت */
        .total-assets-card {
            background-color: var(--dashboard-dark-blue);
            color: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 220px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .white-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            border: 1px solid #e5e7eb;
            min-height: 220px;
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 800;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        /* قائمة الأصول */
        .assets-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 4px;
            background: #fff;
            border-left: 3px solid transparent;
        }
        .assets-list-item:hover { background-color: #f9fafb; border-left-color: var(--brand-orange); }
        
        .grade-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: white;
        }

        .btn-jsaas {
            background: linear-gradient(135deg, #fe9b02 0%, #f53f2c 100%);
            color: white;
            transition: all 0.3s;
        }
        .btn-jsaas:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(254, 155, 2, 0.4); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }

        .custom-checkbox input:checked + div {
            background-color: var(--brand-orange);
            border-color: var(--brand-orange);
        }
        
        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="app" class="h-full flex flex-col">

        <div v-if="!currentUser" class="fixed inset-0 z-50 flex items-center justify-center bg-[#f3f5f9]">
            <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl border-t-4 border-[#fe9b02]">
                <div class="text-center mb-8">
                    <img src="image_0.png" class="h-24 mx-auto mb-4 object-contain" @error="handleImageError">
                    <h2 class="text-2xl font-bold text-slate-800">بوابة الموظفين</h2>
                </div>
                <form @submit.prevent="authAction" class="space-y-4">
                    <input v-model="authForm.username" type="text" placeholder="اسم المستخدم" class="w-full p-3 border rounded-lg bg-gray-50 focus:border-orange-400 outline-none">
                    <input v-model="authForm.password" type="password" placeholder="كلمة المرور" class="w-full p-3 border rounded-lg bg-gray-50 focus:border-orange-400 outline-none">
                    <button type="submit" :disabled="loading" class="btn-jsaas w-full py-3 rounded-lg font-bold">
                        {{ loading ? 'جاري الدخول...' : 'دخول النظام' }}
                    </button>
                </form>
            </div>
        </div>

        <div v-else class="flex h-full overflow-hidden">
            
            <aside class="w-64 bg-white border-l border-gray-200 hidden md:flex flex-col z-20 shadow-sm shrink-0">
                <div class="p-6 border-b flex items-center gap-3">
                    <img :src="currentUser.image || 'https://via.placeholder.com/50'" class="w-10 h-10 rounded-full border border-orange-200 object-cover">
                    <div>
                        <h3 class="font-bold text-sm text-slate-800">{{ currentUser.username }}</h3>
                        <span class="text-xs text-orange-500">{{ getRoleName(currentUser.role) }}</span>
                    </div>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a @click="currentPage='dashboard'" :class="currentPage==='dashboard'?'bg-orange-50 text-orange-600 border-r-4 border-orange-500':'text-gray-500 hover:bg-gray-50'" class="flex items-center p-3 cursor-pointer transition rounded-l-lg">
                        <i class="fas fa-chart-pie ml-3 text-lg w-6 text-center"></i> <span class="font-bold">لوحة المعلومات</span>
                    </a>
                    <a @click="currentPage='reports'" :class="currentPage==='reports'?'bg-orange-50 text-orange-600 border-r-4 border-orange-500':'text-gray-500 hover:bg-gray-50'" class="flex items-center p-3 cursor-pointer transition rounded-l-lg">
                        <i class="fas fa-clipboard-check ml-3 text-lg w-6 text-center"></i> <span class="font-bold">التقارير والقوالب</span>
                    </a>
                    <a v-if="currentUser.role==='manager'" @click="currentPage='users'" :class="currentPage==='users'?'bg-orange-50 text-orange-600 border-r-4 border-orange-500':'text-gray-500 hover:bg-gray-50'" class="flex items-center p-3 cursor-pointer transition rounded-l-lg">
                        <i class="fas fa-users ml-3 text-lg w-6 text-center"></i> <span class="font-bold">الموظفين</span>
                    </a>
                </nav>
                <div class="p-4 border-t">
                    <button @click="logout" class="flex items-center gap-2 text-red-500 hover:text-red-700 font-bold text-sm w-full"><i class="fas fa-sign-out-alt"></i> تسجيل خروج</button>
                </div>
            </aside>

            <main class="flex-1 overflow-y-auto p-4 md:p-8 bg-[#f8f9fa]">
                
                <div class="md:hidden flex justify-between items-center mb-4 bg-white p-3 rounded-lg shadow-sm">
                    <span class="font-bold text-slate-700">نظام الصيانة</span>
                    <button @click="logout" class="text-red-500"><i class="fas fa-sign-out-alt"></i></button>
                </div>

                <div v-if="currentPage === 'dashboard'" class="max-w-7xl mx-auto">
                    <div class="mb-6 flex justify-between items-end">
                        <div>
                            <h1 class="text-2xl font-black text-slate-800">لوحة معلومات الصيانة</h1>
                            <p class="text-gray-500 text-sm mt-1">نظرة عامة حية على حالة الأصول والتقارير.</p>
                        </div>
                        <div class="text-xs text-gray-400 font-bold">بيانات حقيقية محدثة</div>
                    </div>

                    <div class="dashboard-grid">
                        
                        <div class="dashboard-col">
                            <div class="total-assets-card">
                                <h3 class="text-lg font-bold mb-4 opacity-90 border-b border-white/20 pb-2 w-3/4 text-center">إجمالي الأصول</h3>
                                <div class="flex flex-col items-center gap-2">
                                    <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-[#000c3b] text-2xl shadow-lg">
                                        <i class="fas fa-boxes"></i>
                                    </div>
                                    <span class="text-5xl font-black mt-2">{{ stats.total }}</span>
                                    <span class="text-xs opacity-75">مشروع مسجل</span>
                                </div>
                            </div>

                            <div class="white-card flex-1">
                                <div class="card-title">
                                    <span>الأصول الأكثر أهمية</span>
                                    <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500">حسب الأولوية</span>
                                </div>
                                <div class="overflow-y-auto max-h-80 pr-1">
                                    <div v-for="report in sortedReports" :key="report.id" class="assets-list-item cursor-pointer" @click="openEditModal(report)">
                                        <div class="flex flex-col">
                                            <span class="font-bold text-sm text-slate-800 truncate max-w-[150px]">{{ report.title }}</span>
                                            <span class="text-[10px] text-gray-400"><i class="far fa-user"></i> {{ report.assignedTo || 'غير محدد' }}</span>
                                        </div>
                                        <div class="grade-badge" :class="getGradeColor(report.progress)">
                                            {{ getGradeLetter(report.progress) }}
                                        </div>
                                    </div>
                                    <div v-if="sortedReports.length === 0" class="text-center text-gray-400 py-4 text-sm">لا توجد بيانات</div>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-col">
                            <div class="white-card">
                                <div class="card-title">
                                    <span>حالة الأصول (Status)</span>
                                </div>
                                <div class="h-48 relative flex justify-center">
                                    <canvas id="assetStatusChart"></canvas>
                                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <div class="text-center">
                                            <span class="block text-2xl font-bold text-slate-700">{{ stats.active }}</span>
                                            <span class="text-[10px] text-gray-400">نشط حالياً</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="white-card">
                                <div class="card-title">
                                    <span>توزيع المهام (Workload)</span>
                                </div>
                                <div class="h-48 relative flex justify-center">
                                    <canvas id="workloadChart"></canvas> </div>
                                <p class="text-[10px] text-center text-gray-400 mt-2">توزيع المشاريع حسب المسؤول</p>
                            </div>
                        </div>

                        <div class="dashboard-col">
                            <div class="white-card">
                                <div class="card-title">
                                    <span>حالة التقارير (Reports)</span>
                                </div>
                                <div class="h-48 w-full">
                                    <canvas id="reportsBarChart"></canvas>
                                </div>
                            </div>

                            <div class="white-card">
                                <div class="card-title">
                                    <span>التطور الشهري (Evolution)</span>
                                    <span class="text-[10px] text-gray-400">آخر 6 أشهر</span>
                                </div>
                                <div class="h-48 w-full">
                                    <canvas id="evolutionChart"></canvas>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div v-if="currentPage === 'reports'" class="max-w-6xl mx-auto space-y-6">
                    <div class="flex gap-4 border-b border-gray-200 pb-2">
                        <button @click="reportTab='templates'" :class="reportTab==='templates'?'text-[#fe9b02] border-b-2 border-[#fe9b02]':'text-gray-500'" class="pb-2 px-4 font-bold text-lg"><i class="fas fa-layer-group"></i> القوالب</button>
                        <button @click="reportTab='history'" :class="reportTab==='history'?'text-[#fe9b02] border-b-2 border-[#fe9b02]':'text-gray-500'" class="pb-2 px-4 font-bold text-lg"><i class="fas fa-history"></i> الأرشيف</button>
                    </div>

                    <div v-if="reportTab === 'templates'">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700">قوالب الفحص الجاهزة</h3>
                            <button @click="openTemplateModal()" class="btn-jsaas px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                                <i class="fas fa-plus"></i> إنشاء قالب جديد
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div v-for="temp in templates" :key="temp.id" class="white-card border-t-4 border-[#fe9b02] hover:shadow-lg transition relative min-h-[150px]">
                                <div class="absolute top-2 left-2">
                                    <button @click="deleteTemplate(temp.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                                <h4 class="font-bold text-lg text-slate-800 mb-2">{{ temp.title }}</h4>
                                <p class="text-xs text-gray-500 mb-4">{{ temp.tasks.length }} نقطة فحص</p>
                                <div class="mt-auto">
                                    <button @click="useTemplate(temp)" class="w-full bg-slate-50 text-slate-700 py-2 rounded border border-slate-200 hover:bg-[#fe9b02] hover:text-white transition font-bold text-sm">
                                        <i class="fas fa-play"></i> بدء الفحص
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="reportTab === 'history'">
                        <div class="white-card">
                            <h3 class="font-bold text-slate-700 mb-4">سجل الفحوصات</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-right">
                                    <thead class="bg-gray-50 text-gray-600 border-b">
                                        <tr>
                                            <th class="p-3">اسم التقرير</th>
                                            <th class="p-3">التاريخ</th>
                                            <th class="p-3">بواسطة</th>
                                            <th class="p-3">الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="entry in dailyEntries" :key="entry.id" class="border-b hover:bg-gray-50">
                                            <td class="p-3 font-bold">{{ entry.templateTitle }}</td>
                                            <td class="p-3">{{ formatDate(entry.timestamp) }}</td>
                                            <td class="p-3"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs">{{ entry.submittedBy }}</span></td>
                                            <td class="p-3">
                                                <span v-if="entry.allDone" class="text-green-600"><i class="fas fa-check-circle"></i> مكتمل</span>
                                                <span v-else class="text-orange-500"><i class="fas fa-exclamation-circle"></i> ملاحظات</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div v-if="showTemplateModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
            <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden animate-fade-in">
                <div class="bg-slate-800 p-4 flex justify-between items-center text-white">
                    <h3 class="font-bold">إنشاء قالب جديد</h3>
                    <button @click="showTemplateModal=false"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                    <input v-model="newTemplate.title" placeholder="اسم القالب (مثلاً: فحص مولدات)" class="w-full p-2 border rounded focus:border-[#fe9b02] outline-none">
                    <div v-for="(task, idx) in newTemplate.tasks" :key="idx" class="flex gap-2">
                        <input v-model="task.desc" placeholder="المهمة..." class="flex-1 p-2 border rounded bg-gray-50 text-sm">
                        <button @click="newTemplate.tasks.splice(idx, 1)" class="text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                    <button @click="newTemplate.tasks.push({desc:''})" class="text-[#fe9b02] text-sm font-bold"><i class="fas fa-plus"></i> إضافة مهمة</button>
                </div>
                <div class="p-4 border-t bg-gray-50 flex justify-end">
                    <button @click="saveTemplate" class="btn-jsaas px-6 py-2 rounded-lg font-bold">حفظ</button>
                </div>
            </div>
        </div>

        <div v-if="showFillModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
            <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden animate-fade-in">
                <div class="bg-[#fe9b02] p-4 flex justify-between items-center text-white">
                    <h3 class="font-bold">{{ activeEntry.templateTitle }}</h3>
                    <button @click="showFillModal=false"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-6 max-h-[70vh] overflow-y-auto bg-slate-50 space-y-3">
                    <div v-for="(task, idx) in activeEntry.tasks" :key="idx" class="bg-white p-3 rounded border flex items-center justify-between">
                        <span class="text-sm font-bold">{{ task.desc }}</span>
                        <label class="custom-checkbox cursor-pointer relative w-6 h-6">
                            <input type="checkbox" v-model="task.done" class="hidden">
                            <div class="w-6 h-6 border-2 border-gray-300 rounded flex items-center justify-center transition">
                                <i v-if="task.done" class="fas fa-check text-white text-xs"></i>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="p-4 border-t bg-white flex justify-end">
                    <button @click="submitEntry" class="bg-green-600 text-white px-8 py-2 rounded-lg font-bold hover:bg-green-700">حفظ التقرير</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCYWgYL7SqUprocWZMrPuHqnclyOQ5HOc",
            authDomain: "maintenance-app-4b02b.firebaseapp.com",
            projectId: "maintenance-app-4b02b",
            storageBucket: "maintenance-app-4b02b.firebasestorage.app",
            messagingSenderId: "711045496244",
            appId: "1:711045496244:web:c8b00f88cd43b0daa946c1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    currentUser: JSON.parse(localStorage.getItem('jsaas_user_v5')) || null,
                    authForm: { username: '', password: '' },
                    loading: false,
                    currentPage: 'dashboard',
                    reportTab: 'templates',
                    users: [],
                    reports: [],
                    templates: [],
                    dailyEntries: [],
                    showTemplateModal: false,
                    newTemplate: { title: '', tasks: [{desc:''}] },
                    showFillModal: false,
                    activeEntry: null,
                    charts: {}
                }
            },
            computed: {
                stats() {
                    const total = this.reports.length;
                    const active = this.reports.filter(r => r.progress < 100).length;
                    return { total, active };
                },
                sortedReports() {
                    // ترتيب الأصول حسب النسبة الأقل (الأكثر أهمية للصيانة)
                    return [...this.reports].sort((a, b) => a.progress - b.progress);
                }
            },
            methods: {
                async authAction() {
                    this.loading = true;
                    try {
                        const snap = await db.collection('users')
                            .where('username','==',this.authForm.username)
                            .where('password','==',this.authForm.password).get();
                        if(snap.empty) throw "بيانات الدخول غير صحيحة";
                        const u = {id:snap.docs[0].id, ...snap.docs[0].data()};
                        if(u.status!=='active') throw "الحساب غير نشط";
                        this.currentUser = u; 
                        localStorage.setItem('jsaas_user_v5', JSON.stringify(u)); 
                        this.initData();
                    } catch(e) { alert(e); }
                    this.loading = false;
                },
                logout() { localStorage.removeItem('jsaas_user_v5'); location.reload(); },
                getRoleName(r) { return r==='manager'?'مدير النظام':r==='supervisor'?'مشرف صيانة':'فني'; },
                initData() {
                    if(!this.currentUser) return;
                    db.collection("users").onSnapshot(s => this.users = s.docs.map(d => ({id:d.id, ...d.data()})));
                    db.collection("reports").onSnapshot(s => {
                        this.reports = s.docs.map(d => ({id:d.id, ...d.data()}));
                        setTimeout(this.processRealDataForCharts, 500);
                    });
                    db.collection("report_templates").onSnapshot(s => this.templates = s.docs.map(d => ({id:d.id, ...d.data()})));
                    db.collection("daily_entries").orderBy("timestamp", "desc").limit(20)
                        .onSnapshot(s => this.dailyEntries = s.docs.map(d => ({id:d.id, ...d.data()})));
                },
                // === معالجة البيانات الحقيقية للرسوم البيانية ===
                processRealDataForCharts() {
                    if(this.currentPage !== 'dashboard') return;
                    
                    // 1. Asset Status (حسب نسبة الإنجاز)
                    let grades = { A: 0, B: 0, C: 0, D: 0 };
                    this.reports.forEach(r => {
                        if(r.progress >= 85) grades.A++;
                        else if(r.progress >= 70) grades.B++;
                        else if(r.progress >= 50) grades.C++;
                        else grades.D++;
                    });

                    this.renderChart('assetStatusChart', 'doughnut', {
                        labels: ['ممتاز (A)', 'جيد (B)', 'مقبول (C)', 'حرج (D)'],
                        datasets: [{
                            data: [grades.A, grades.B, grades.C, grades.D],
                            backgroundColor: ['#000c3b', '#004e98', '#ff6b35', '#f53f2c'],
                            borderWidth: 0, cutout: '60%'
                        }]
                    }, { plugins: { legend: { display: false } } });

                    // 2. Reports Status (مكتملة vs قيد التنفيذ vs متأخرة)
                    let status = { completed: 0, inProgress: 0, overdue: 0 };
                    const now = new Date();
                    this.reports.forEach(r => {
                        if(r.progress === 100) status.completed++;
                        else {
                            if(r.endDate && new Date(r.endDate) < now) status.overdue++;
                            else status.inProgress++;
                        }
                    });

                    this.renderChart('reportsBarChart', 'bar', {
                        labels: ['مكتملة', 'جارية', 'متأخرة'],
                        datasets: [{
                            data: [status.completed, status.inProgress, status.overdue],
                            backgroundColor: '#00b4d8', barThickness: 20
                        }]
                    }, { 
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
                    });

                    // 3. Workload (بدلاً من الأعطال الوهمية - نعرض توزيع الموظفين الحقيقي)
                    let assignments = {};
                    this.reports.forEach(r => {
                        let user = r.assignedTo || 'Unassigned';
                        assignments[user] = (assignments[user] || 0) + 1;
                    });
                    const assignLabels = Object.keys(assignments);
                    const assignData = Object.values(assignments);

                    this.renderChart('workloadChart', 'doughnut', {
                        labels: assignLabels,
                        datasets: [{
                            data: assignData.length ? assignData : [1], // لو مفيش بيانات نعرض 1 كشكل
                            backgroundColor: ['#000c3b', '#f53f2c', '#fe9b02', '#004e98', '#999'],
                            borderWidth: 0, cutout: '50%'
                        }]
                    }, { plugins: { legend: { display: false } } });

                    // 4. Evolution (التطور الزمني الحقيقي حسب تاريخ الإنشاء)
                    let months = {};
                    this.reports.forEach(r => {
                        let date = r.timestamp ? new Date(r.timestamp.seconds * 1000) : new Date();
                        let key = date.toLocaleString('en-US', { month: 'short' });
                        months[key] = (months[key] || 0) + 1;
                    });
                    
                    this.renderChart('evolutionChart', 'bar', {
                        labels: Object.keys(months),
                        datasets: [{ 
                            label: 'تقارير جديدة',
                            data: Object.values(months), 
                            backgroundColor: '#000c3b' 
                        }]
                    }, { 
                        plugins: { legend: { display: false } },
                        scales: { x: { grid:{display:false} }, y: { beginAtZero: true } }
                    });
                },
                renderChart(id, type, data, options) {
                    const ctx = document.getElementById(id);
                    if(!ctx) return;
                    if(this.charts[id]) this.charts[id].destroy();
                    this.charts[id] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, ...options } });
                },
                getGradeLetter(p) { return p >= 85 ? 'A' : p >= 70 ? 'B' : p >= 50 ? 'C' : 'D'; },
                getGradeColor(p) { return p >= 85 ? 'bg-green-500' : p >= 70 ? 'bg-blue-500' : p >= 50 ? 'bg-yellow-500' : 'bg-red-500'; },
                formatDate(ts) { return ts ? new Date(ts.seconds * 1000).toLocaleDateString('ar-EG') : ''; },
                openTemplateModal() { this.newTemplate={title:'', tasks:[{desc:''}]}; this.showTemplateModal=true; },
                saveTemplate() {
                    if(!this.newTemplate.title) return alert("مطلوب العنوان");
                    const valid = this.newTemplate.tasks.filter(t=>t.desc);
                    if(!valid.length) return alert("مهمة واحدة على الأقل");
                    db.collection("report_templates").add({
                        title: this.newTemplate.title, tasks: valid, createdBy: this.currentUser.username
                    });
                    this.showTemplateModal=false;
                },
                deleteTemplate(id) { if(confirm("حذف؟")) db.collection("report_templates").doc(id).delete(); },
                useTemplate(t) {
                    this.activeEntry = { templateId: t.id, templateTitle: t.title, tasks: t.tasks.map(k=>({desc:k.desc, done:false})), submittedBy: this.currentUser.username, timestamp: new Date() };
                    this.showFillModal=true;
                },
                submitEntry() {
                    const allDone = this.activeEntry.tasks.every(t=>t.done);
                    db.collection("daily_entries").add({...this.activeEntry, allDone, timestamp: firebase.firestore.FieldValue.serverTimestamp()});
                    this.showFillModal=false;
                    alert("تم الحفظ");
                }
            },
            mounted() { if(this.currentUser) this.initData(); }
        }).mount('#app');
    </script>
</body>
</html>